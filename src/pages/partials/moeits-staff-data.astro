---
import fs from "node:fs/promises";
import path from "node:path";
import QuoteCard from "./QuoteCard.astro";

const BASE_DIR = path.resolve("public/data");
const filename = "moeits-staff";
const groupId = "d0dd07fc-dc48-4d16-9439-39f479c9dc05";
const hoursThreshold = 3 * 60 * 60 * 1000; // 3 hours
let events: EventData = null;

try {
  const date = await fs.readFile(
    path.join(BASE_DIR, `${filename}-last-pull-timestamp.txt`),
    "utf-8",
  );

  const savedDate = new Date(date);
  const now = new Date();

  const timeDifference = now.getTime() - savedDate.getTime();

  if (timeDifference >= hoursThreshold) {
    console.log(
      "fetching fresh data | timeDifference is older than hoursThreshold",
    );
    await fs.writeFile(
      path.join(BASE_DIR, `last-pull-date.txt`),
      now.toISOString(),
      "utf-8",
    );

    function dateFromNow(days: number) {
      const d = new Date();
      now.setDate(d.getDate() + days);
      return d;
    }

    // TODO set start and end times 1 month before and after current time.
    const startTime = dateFromNow(-30);
    const endTime = dateFromNow(-65);

    // debug @ https://developer.microsoft.com/en-us/graph/graph-explorer
    // endpoint -> https://graph.microsoft.com/v1.0/groups/d0dd07fc-dc48-4d16-9439-39f479c9dc05/calendar/calendarView?startDateTime=2026-01-01T00:00:00&endDateTime=2026-02-01T00:00:00
    const response = await fetch(
      `https://graph.microsoft.com/v1.0/groups/${groupId}/calendar/calendarView?startDateTime=${startTime}&endDateTime=${endTime}`,
      {
        method: "GET",
        headers: {
          Authorization: `Bearer ${import.meta.env.MS_TOKEN}`,
          "Content-Type": "application/json",
        },
      },
    );

    if (!response.ok) {
      console.error(`Error: ${response.status} ${response.statusText}`);
      const errorData = await response.json();
      console.error(errorData);
      return;
    }

    events = await response.json();
    await fs.writeFile(
      path.join(BASE_DIR, `${filename}.json`),
      now.toISOString(),
      "utf-8",
    );
  } else {
    console.log(
      "fetching cached data | timeDifference is younger than hoursThreshold",
    );
    const eventsString = await fs.readFile(
      path.join(BASE_DIR, `${filename}.json`),
      "utf-8",
    );
    events = JSON.parse(eventsString);
  }
} catch (error) {
  console.log(error);
}

if (events) {
  //   console.log({ events });
} else {
  console.log("no quotes found!!!");
}

function toLocalTime(dateString: string) {
  const date = new Date(dateString + "Z");
  return date.toLocaleString();
}

// other important data points to use
// isAllDay, isCancelled, showAs, type, isDraft
---

<ul>
  {
    events ? (
      events?.value.map((item) => (
        <li>
          <h3>{item.subject}</h3>
          <table>
            <tr>
              <td>start:</td>
              <td>{toLocalTime(item.start.dateTime)}</td>
            </tr>
            <tr>
              <td>end:</td>
              <td>{toLocalTime(item.end.dateTime)}</td>
            </tr>
          </table>
        </li>
      ))
    ) : (
      <li>no events found</li>
    )
  }
</ul>
