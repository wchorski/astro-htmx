---
import fs from "node:fs/promises";
import path from "node:path";
import QuoteCard from "./QuoteCard.astro";

const BASE_DIR = path.resolve("public/data");
const filename = "quotes";
let quote = null;
let author = null;
const hoursThreshold = 72 * 60 * 60 * 1000; // 72 hours

try {
  const date = await fs.readFile(
    path.join(BASE_DIR, `last-pull-date.txt`),
    "utf-8",
  );
  
  console.log(date);
  // 1.   Check if it's a new day (past 24 hours)
  // 2.a if yes fetch fresh data
  // 2.b save data
  // 3.A if no use existing data at 'public/data/quotes.json'
  //   fs.readFile(path.join(BASE_DIR, `${filename}.json`), "utf-8");

  const savedDate = new Date(date);
  const now = new Date();

  const timeDifference = now.getTime() - savedDate.getTime();

  if (timeDifference >= hoursThreshold) {
    console.log("fetching fresh data | timeDifference is older than hoursThreshold");
    await fs.writeFile(path.join(BASE_DIR, `last-pull-date.txt`), now.toISOString(), "utf-8");

    const response = await fetch("https://zenquotes.io/api/quotes/");
    const quotes = await response.json();

    // Select random quote
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
    quote = randomQuote.q;
    author = randomQuote.a;
  } else {
    console.log("fetching cached data | timeDifference is younger than hoursThreshold");
    const quotesString = await fs.readFile(
      path.join(BASE_DIR, `${filename}.json`),
      "utf-8",
    );
    const quoteJSON = JSON.parse(quotesString);
    const randomQuote = quoteJSON[Math.floor(Math.random() * quoteJSON.length)];
    quote = randomQuote.q;
    author = randomQuote.a;
  }
} catch (error) {
  console.log(error);
  quote = "Unable to load quotes at this time.";
  author = "Error";
}
---

<QuoteCard quote={quote} author={author} />
